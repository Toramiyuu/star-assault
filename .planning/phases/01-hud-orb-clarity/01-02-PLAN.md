---
phase: 01-hud-orb-clarity
plan: "02"
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - src/systems/HUD.js
  - src/ui/StatBar.js
  - src/scenes/GameScene.js
autonomous: false
requirements:
  - VISC-03

must_haves:
  truths:
    - "No stat strip (DMG/RATE/SPD/SH/HP/CRIT/PIER/STK) appears at the bottom of the screen during a wave"
    - "The kill streak counter (x5, x10 ON FIRE, x20 UNSTOPPABLE) still displays top-right during gameplay"
    - "Shield and HP fill bars animate smoothly on damage/gain instead of jumping instantly"
    - "Rapid damage events do not accumulate tween debt — the bar jumps to final value without lag"
  artifacts:
    - path: "src/systems/HUD.js"
      provides: "streakText display (migrated from StatBar); tween proxy pattern for shield and HP bars"
      contains: "streakText"
    - path: "src/scenes/GameScene.js"
      provides: "StatBar removed; HUD.updateStreak() called instead"
      contains: "hud.updateStreak"
  key_links:
    - from: "src/scenes/GameScene.js"
      to: "src/systems/HUD.js"
      via: "this.hud.updateStreak(this.killStreak || 0) in GameScene.update()"
      pattern: "hud\\.updateStreak"
    - from: "src/systems/HUD.js"
      to: "_shieldRatioCurrent / _healthRatioCurrent"
      via: "tween proxy in update() dirty-flag check"
      pattern: "_shieldRatioTarget|_healthRatioTarget"
---

<objective>
Remove the bottom stat bar from the live gameplay HUD, migrate the kill streak counter to HUD.js, and add smooth tween animation to the shield and HP fill bars.

Purpose: The 8-stat strip (DMG/RATE/SPD etc.) is confirmed anti-feature — players can't read it mid-combat, it occupies bottom screen real estate during wave play. Smooth bar animation makes damage feel responsive instead of jarring.
Output: StatBar.js deleted; HUD.js owns streak counter; shield and HP bars animate smoothly.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-hud-orb-clarity/01-CONTEXT.md
@.planning/phases/01-hud-orb-clarity/01-RESEARCH.md
@.planning/phases/01-hud-orb-clarity/01-01-SUMMARY.md
@src/systems/HUD.js
@src/ui/StatBar.js
@src/scenes/GameScene.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate streak counter to HUD.js and remove StatBar</name>
  <files>src/systems/HUD.js, src/ui/StatBar.js, src/scenes/GameScene.js</files>
  <action>
**Step 1 — Add streak text to HUD constructor (src/systems/HUD.js):**

After the existing `this.bossBarFill = null;` line at the end of the constructor, add:

```javascript
// Kill streak counter (migrated from StatBar)
this.streakText = scene.add.text(GAME.WIDTH - 40, 10, '', {
    fontFamily: 'Arial',
    fontSize: '28px',
    color: '#ffffff',
    fontStyle: 'bold',
    stroke: '#000000',
    strokeThickness: 3,
}).setOrigin(1, 0).setDepth(101).setScrollFactor(0);
```

**Step 2 — Add updateStreak() method to HUD.js:**

Add this method after the `hideBossHP()` method (before the closing `}`):

```javascript
updateStreak(streak) {
    if (streak <= 0) {
        this.streakText.setVisible(false);
    } else {
        this.streakText.setVisible(true);
        if (streak >= 20) {
            this.streakText.setText(`x${streak} UNSTOPPABLE`);
            this.streakText.setColor('#ff4444');
            this.streakText.setFontSize(32);
        } else if (streak >= 10) {
            this.streakText.setText(`x${streak} ON FIRE`);
            this.streakText.setColor('#ff8800');
            this.streakText.setFontSize(30);
        } else {
            this.streakText.setText(`x${streak}`);
            this.streakText.setColor('#ffffff');
            this.streakText.setFontSize(28);
        }
    }
}
```

Regarding Claude's Discretion: Kill streak accent color — leave white/yellow/red as-is (these are emergency feedback colors; orange would conflict with the HP-damage aesthetic).

**Step 3 — Update GameScene.js:**

Remove the StatBar import line (line 26):
```
DELETE: import { StatBar } from "../ui/StatBar.js";
```

Remove StatBar construction (line 87):
```
DELETE: this.statBar = new StatBar(this);
```

In `GameScene.update()`, replace the statBar update call (line 462):
```
DELETE: this.statBar.update();
ADD:    this.hud.updateStreak(this.killStreak || 0);
```

The `this.hud` reference is constructed at line ~87 in `create()` so it is available before `update()` runs. Do not duplicate `this.hud.update(score, hp)` — that call already exists elsewhere in `GameScene.update()`.

**Step 4 — Delete StatBar.js:**

Delete `src/ui/StatBar.js` using the Bash tool. Before deleting, grep for any other files that import StatBar — only GameScene.js should match and it will already be cleaned in Step 3.
  </action>
  <verify>
    <automated>grep -rn "StatBar\|statBar" src/ && echo "FOUND_REFERENCES" || echo "CLEAN"</automated>
    <manual>Run `npm run dev`. Start a wave. Confirm: (1) bottom of screen is clear — no stat strip with DMG/RATE/SPD/etc. (2) Kill enemies and confirm streak counter appears top-right (e.g. "x5", "x10 ON FIRE"). (3) Check browser console for import errors — there must be no "Cannot find module StatBar" error.</manual>
    <sampling_rate>After this task, before Task 2</sampling_rate>
  </verify>
  <done>No `StatBar` or `statBar` references exist anywhere in src/. `src/ui/StatBar.js` does not exist. HUD.js has `streakText` and `updateStreak()`. Game runs without console errors. Kill streak counter visible top-right when streak > 0.</done>
</task>

<task type="auto">
  <name>Task 2: Add dirty-flag tween proxy to HUD shield and HP bars</name>
  <files>src/systems/HUD.js</files>
  <action>
Implement the tween proxy pattern for smooth bar animation in HUD.js. The key insight: `tweens.add()` can target any plain object with numeric properties — the HUD instance itself qualifies. This avoids the Graphics scaleX pivot problem (Graphics objects don't support setOrigin, so scale tweens would shift the bar leftward).

**Step 1 — Add proxy properties in HUD constructor**, immediately after the existing lines:
```javascript
this._shieldRatio = 1;
this._healthRatio = 1;
this._shieldRecharging = false;
this._lowHpPulsing = false;
```

Append these lines immediately after that block:
```javascript
this._shieldRatioCurrent = 1;   // animated display value (tweened)
this._healthRatioCurrent = 1;   // animated display value (tweened)
this._shieldRatioTarget  = 1;   // actual target value
this._healthRatioTarget  = 1;   // actual target value
this._shieldTween = null;
this._healthTween = null;
```

**Step 2 — Refactor shield fill section in HUD.update():**

The current shield fill block (lines 129-139) clears and redraws every frame without animation. Replace it with:

```javascript
// Shield fill — dirty-flag tween proxy
const shieldRatioNew = shieldMax > 0 ? Math.max(0, shieldCur / shieldMax) : 0;
if (shieldRatioNew !== this._shieldRatioTarget) {
    this._shieldRatioTarget = shieldRatioNew;
    if (this._shieldTween) { this._shieldTween.stop(); this._shieldTween = null; }
    this._shieldTween = this.scene.tweens.add({
        targets: this,
        _shieldRatioCurrent: shieldRatioNew,
        duration: 150,
        ease: 'Power2.easeOut',
        onComplete: () => { this._shieldTween = null; }
    });
}
this.shieldBarFill.clear();
if (this._shieldRatioCurrent > 0) {
    this.shieldBarFill.fillStyle(0x4488ff, 1);
    this.shieldBarFill.fillRoundedRect(
        BAR_X + 1, SHIELD_Y - BAR_H / 2 + 1,
        (BAR_W - 2) * this._shieldRatioCurrent, BAR_H - 2,
        CORNER_R
    );
}
```

The `shieldRatio` local variable is no longer needed for the fill draw. The shieldGlow block that follows uses `isRecharging`, `shieldCur`, and `shieldMax` directly — those remain available. No changes needed to the glow block.

**Step 3 — Refactor health fill section in HUD.update():**

The current health fill block (lines 159-173) draws every frame. Replace:

```javascript
// Health fill — dirty-flag tween proxy
const healthRatioNew = hpMax > 0 ? Math.max(0, hpCur / hpMax) : 0;
if (healthRatioNew !== this._healthRatioTarget) {
    this._healthRatioTarget = healthRatioNew;
    if (this._healthTween) { this._healthTween.stop(); this._healthTween = null; }
    this._healthTween = this.scene.tweens.add({
        targets: this,
        _healthRatioCurrent: healthRatioNew,
        duration: 150,
        ease: 'Power2.easeOut',
        onComplete: () => { this._healthTween = null; }
    });
}
this.healthBarFill.clear();
if (this._healthRatioCurrent > 0) {
    const color = this._getHealthColor(this._healthRatioCurrent);
    // Low HP pulse — uses actual hpCur (not animated ratio) for threshold check
    let alpha = 1;
    if (hpCur <= 1 && hpMax > 1) {
        alpha = 0.6 + 0.4 * Math.sin(this.scene.time.now * 0.008);
    }
    this.healthBarFill.fillStyle(color, alpha);
    this.healthBarFill.fillRoundedRect(
        BAR_X + 1, HEALTH_Y - BAR_H / 2 + 1,
        (BAR_W - 2) * this._healthRatioCurrent, BAR_H - 2,
        CORNER_R
    );
}
```

**Critical guards:**
- The `shieldGlow` block (lines 141-152) is SEPARATE from the fill bar — do NOT remove or alter it. It uses `isRecharging` and draws the blue glow halo around the bar; leave it as-is.
- The low-HP alpha pulse (`Math.sin(scene.time.now * 0.008)`) runs every frame unconditionally — this is correct behavior for the pulse effect, not a tween-debt risk (no `tweens.add()` is called in the pulse block).
- Do NOT add `tweens.add()` outside the `if (ratioNew !== this._ratioTarget)` guard — that would create tween debt (60 new tweens per second).

Regarding Claude's Discretion (CONTEXT.md): existing low-HP red pulse and shield-recharge glow pulse — leave them at current duration/intensity. Both are working effects; no tuning needed.
  </action>
  <verify>
    <automated>grep -n "_shieldRatioCurrent\|_healthRatioCurrent\|_shieldRatioTarget\|_healthRatioTarget\|_shieldTween\|_healthTween" src/systems/HUD.js</automated>
    <manual>Run `npm run dev`. (1) Disable god mode. Take damage — shield bar should slide down smoothly (~150ms ease-out), not jump. (2) Take HP damage — health bar should tween down smoothly. (3) Collect shield drop — bar should animate back up. (4) Take rapid damage (multiple bullets in quick succession) — bar must NOT lag behind; it should jump to the correct final value without animation debt. (5) Check performance — no slowdown from rapid hits.</manual>
    <sampling_rate>After this task completes</sampling_rate>
  </verify>
  <done>HUD.js contains `_shieldRatioCurrent`, `_healthRatioCurrent`, `_shieldRatioTarget`, `_healthRatioTarget`, `_shieldTween`, `_healthTween`. Shield and HP fill bars animate on value change with 150ms ease-out. No tween debt on rapid damage. ShieldGlow pulse block is untouched.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Phase 1 human verification — orbs, stat bar, streak, bar animation</name>
  <files>none</files>
  <action>Human visual verification of all Phase 1 outcomes in a running browser session.</action>
  <verify>
    <automated>echo "checkpoint — manual verification required"</automated>
    <manual>
    Run `npm run dev` and verify all Phase 1 success criteria:

    1. XP Orbs (VISC-01):
       - Enable god mode (I key), advance waves with N key
       - Waves 4-5 (Nebula Zone, pink-red background): XP orbs must be clearly orange/gold — not blending into background
       - Waves 12-13 (Void Rift, dark): orbs must glow visibly orange
       - Outer glow breathes (dims and brightens) — orb size stays constant
       - Move player near orbs: magnet trail lines are orange
       - XP bar fill is orange, LV text is orange, XP bar border is orange

    2. Upgrade Cards (VISC-01 color consistency):
       - Press U (force level-up): upgrade card stat value text and NEW label are orange
       - No green text appears on any upgrade card

    3. Stat Bar Removal (VISC-03):
       - Bottom of screen during wave: NO strip with DMG/RATE/SPD/SH/HP/CRIT/PIER/STK
       - Top-right corner: kill enemies, streak counter appears (x5, x10 ON FIRE, x20 UNSTOPPABLE)
       - No console errors about missing modules

    4. HUD Bar Animation:
       - Disable god mode, take damage: shield bar animates smoothly down (~150ms)
       - Take HP damage: health bar animates smoothly
       - Rapid damage (multiple hits fast): bar reaches correct value without lagging
    </manual>
  </verify>
  <done>User types "approved" confirming all four areas pass. Or user describes specific issues for gap closure.</done>
</task>

</tasks>

<verification>
Full Phase 1 verification checklist:
- [ ] VISC-01: Orange orbs visible at all 6 background zones (confirm Nebula at waves 4-5)
- [ ] VISC-01: Magnet trail is orange
- [ ] VISC-01: XP bar and LV text are orange
- [ ] VISC-01: Upgrade card stat/NEW text is orange
- [ ] VISC-03: No stat strip at bottom during gameplay
- [ ] VISC-03: Kill streak counter still shows top-right
- [ ] HUD bars: smooth 150ms ease-out animation on damage/gain
- [ ] No console errors from StatBar import removal
- [ ] No performance degradation from rapid hits
</verification>

<success_criteria>
- `src/ui/StatBar.js` does not exist
- No `StatBar` import or usage in any file under `src/`
- `src/systems/HUD.js` has `streakText`, `updateStreak()`, and tween proxy properties (`_shieldRatioCurrent`, `_healthRatioCurrent`, `_shieldRatioTarget`, `_healthRatioTarget`)
- `src/scenes/GameScene.js` calls `this.hud.updateStreak()` (not `this.statBar.update()`)
- HUD fill bars animate smoothly — confirmed by human verification checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/01-hud-orb-clarity/01-02-SUMMARY.md`
</output>
