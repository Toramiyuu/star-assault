---
phase: 01-hud-orb-clarity
plan: "03"
type: execute
wave: 3
depends_on:
  - "01-02"
files_modified:
  - src/systems/HUD.js
autonomous: false
gap_closure: true
requirements:
  - VISC-03

must_haves:
  truths:
    - "Taking shield damage visibly animates the blue shield bar from full to partial in ~150ms"
    - "Taking HP damage visibly animates the red/green health bar from full to partial in ~150ms"
    - "Rapid damage events (multiple hits within 150ms) do not cause the bar to lag — bar reaches correct final value"
    - "Shield recharge animates the bar back up smoothly, not as a jump-cut"
  artifacts:
    - path: "src/systems/HUD.js"
      provides: "Working tween proxy for shield and HP fill bars — tweened via plain proxy objects, not underscore-prefixed properties"
      contains: "_shieldProxy"
  key_links:
    - from: "src/systems/HUD.js"
      to: "Phaser TweenManager"
      via: "tweens.add() targeting _shieldProxy / _healthProxy objects with property 'ratio' (no underscore prefix)"
      pattern: "_shieldProxy\\.ratio|_healthProxy\\.ratio"
    - from: "src/systems/HUD.js shieldBarFill"
      to: "_shieldProxy.ratio"
      via: "fillRoundedRect width = (BAR_W - 2) * this._shieldProxy.ratio each frame"
      pattern: "_shieldProxy\\.ratio"
---

<objective>
Fix HUD shield and HP bars so their fill animation actually fires at runtime — the tween proxy pattern was silently broken because Phaser skips any tween config property starting with underscore.

Purpose: User-confirmed gap: taking damage produces no visible change in the HUD bars. The tween code exists but produces no animation because Phaser's GetProps.js explicitly filters out any property key beginning with `_` (line 45: `key.substring(0, 1) !== '_'`). This means `_shieldRatioCurrent` and `_healthRatioCurrent` were never tweened — they stayed at their initial values permanently.

Output: Two proxy plain-objects (`_shieldProxy` and `_healthProxy`) replace direct property tweening. Each proxy has a `ratio` property (no underscore prefix) that Phaser CAN tween. Fill bars draw from proxy.ratio instead of the old underscore properties.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-hud-orb-clarity/01-CONTEXT.md
@.planning/phases/01-hud-orb-clarity/01-02-SUMMARY.md
@src/systems/HUD.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace underscore-prefixed tween targets with proxy objects in HUD.js</name>
  <files>src/systems/HUD.js</files>
  <action>
The root cause is confirmed: Phaser's TweenBuilder (node_modules/phaser/src/tweens/builders/GetProps.js line 45) explicitly skips any tween config key that starts with `_`. The tween config `{ _shieldRatioCurrent: value }` was always a silent no-op — the property was never animated.

Fix: replace the two current-value properties with proxy plain objects whose `ratio` property (no underscore) Phaser CAN tween.

**Step 1 — Replace proxy property declarations in the constructor**

Find and REMOVE these six lines (added by plan 01-02):
```javascript
this._shieldRatioCurrent = 1;   // animated display value (tweened)
this._healthRatioCurrent = 1;   // animated display value (tweened)
this._shieldRatioTarget  = 1;   // actual target value
this._healthRatioTarget  = 1;   // actual target value
this._shieldTween = null;
this._healthTween = null;
```

ADD these five lines in their place:
```javascript
this._shieldProxy = { ratio: 1 };  // tween target — 'ratio' has no underscore prefix so Phaser will tween it
this._healthProxy = { ratio: 1 };  // tween target
this._shieldRatioTarget = 1;       // dirty-flag comparator (not tweened, underscore OK)
this._healthRatioTarget = 1;       // dirty-flag comparator
this._shieldTween = null;          // handle for stop-before-retarget
this._healthTween = null;
```

**Step 2 — Fix the shield fill section in update()**

Find the shield fill block that starts with:
```javascript
// Shield fill — dirty-flag tween proxy
const shieldRatioNew = shieldMax > 0 ? Math.max(0, shieldCur / shieldMax) : 0;
```

Replace the entire shield fill block (from the `shieldRatioNew` declaration through the closing `}` of the fill draw, ending at the shieldGlow section) with:

```javascript
// Shield fill — dirty-flag tween proxy
const shieldRatioNew = shieldMax > 0 ? Math.max(0, shieldCur / shieldMax) : 0;
if (shieldRatioNew !== this._shieldRatioTarget) {
    this._shieldRatioTarget = shieldRatioNew;
    if (this._shieldTween) { this._shieldTween.stop(); this._shieldTween = null; }
    this._shieldTween = this.scene.tweens.add({
        targets: this._shieldProxy,
        ratio: shieldRatioNew,
        duration: 150,
        ease: 'Power2.easeOut',
        onComplete: () => { this._shieldTween = null; }
    });
}
this.shieldBarFill.clear();
if (this._shieldProxy.ratio > 0) {
    this.shieldBarFill.fillStyle(0x4488ff, 1);
    this.shieldBarFill.fillRoundedRect(
        BAR_X + 1, SHIELD_Y - BAR_H / 2 + 1,
        (BAR_W - 2) * this._shieldProxy.ratio, BAR_H - 2,
        CORNER_R
    );
}
```

Key change: `targets: this._shieldProxy` and `ratio: shieldRatioNew` (not `_shieldRatioCurrent`). The fill draw now reads `this._shieldProxy.ratio` instead of `this._shieldRatioCurrent`.

**Step 3 — Fix the health fill section in update()**

Find the health fill block that starts with:
```javascript
// Health fill — dirty-flag tween proxy
const healthRatioNew = hpMax > 0 ? Math.max(0, hpCur / hpMax) : 0;
```

Replace the entire health fill block with:

```javascript
// Health fill — dirty-flag tween proxy
const healthRatioNew = hpMax > 0 ? Math.max(0, hpCur / hpMax) : 0;
if (healthRatioNew !== this._healthRatioTarget) {
    this._healthRatioTarget = healthRatioNew;
    if (this._healthTween) { this._healthTween.stop(); this._healthTween = null; }
    this._healthTween = this.scene.tweens.add({
        targets: this._healthProxy,
        ratio: healthRatioNew,
        duration: 150,
        ease: 'Power2.easeOut',
        onComplete: () => { this._healthTween = null; }
    });
}
this.healthBarFill.clear();
if (this._healthProxy.ratio > 0) {
    const color = this._getHealthColor(this._healthProxy.ratio);
    let alpha = 1;
    if (hpCur <= 1 && hpMax > 1) {
        alpha = 0.6 + 0.4 * Math.sin(scene.time.now * 0.008);
    }
    this.healthBarFill.fillStyle(color, alpha);
    this.healthBarFill.fillRoundedRect(
        BAR_X + 1, HEALTH_Y - BAR_H / 2 + 1,
        (BAR_W - 2) * this._healthProxy.ratio, BAR_H - 2,
        CORNER_R
    );
}
```

Key change: `targets: this._healthProxy`, `ratio: healthRatioNew`, draw reads `this._healthProxy.ratio`. Color also uses `this._healthProxy.ratio` for the gradient.

**Do NOT touch:** shieldGlow pulse block, low-HP pulse logic, updateStreak(), updateXPBar(), showBossHP(), or any constructor code other than the six lines being replaced.
  </action>
  <verify>
    <automated>grep -n "_shieldProxy\|_healthProxy\|_shieldRatioCurrent\|_healthRatioCurrent" src/systems/HUD.js</automated>
    <manual>Confirm: `_shieldRatioCurrent` and `_healthRatioCurrent` do NOT appear in the output (they are gone). Confirm: `_shieldProxy` and `_healthProxy` DO appear (they are the new proxy objects). The automated check is sufficient to confirm the rename — runtime animation is verified in Task 2.</manual>
    <sampling_rate>After this task, before Task 2</sampling_rate>
  </verify>
  <done>`_shieldRatioCurrent` and `_healthRatioCurrent` no longer exist in HUD.js. `_shieldProxy` and `_healthProxy` exist. Tween targets use `ratio` (no underscore prefix). Fill draw reads `this._shieldProxy.ratio` and `this._healthProxy.ratio`.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify HUD bar animation fires at runtime</name>
  <files>none</files>
  <action>Human runtime verification that the shield and HP bars now visibly animate when the player takes damage.</action>
  <verify>
    <automated>echo "checkpoint — manual browser verification required"</automated>
    <manual>
    Run `npm run dev` and open the game in the browser.

    1. Start a new game.
    2. Ensure god mode is OFF (do not press I). You need to take real damage.
    3. Let an enemy bullet hit you.
       Expected: The blue shield bar slides down smoothly (~150ms ease-out) to reflect the lost shield pip.
       NOT expected: No change, or an instant jump with no animation.
    4. If shield is now 0, let another bullet hit you.
       Expected: The red/green HP bar slides down smoothly from full to 4/5.
    5. Wait 4+ seconds (shield recharge cooldown), then 1 more second.
       Expected: The shield bar animates back up as the shield recharges.
    6. Rapid damage test: position near several enemies and take 2-3 hits in quick succession.
       Expected: Bar reaches the correct final value. It should NOT lag or show the wrong value after rapid hits.

    If the bars animate correctly in all four steps above, type "approved".
    If bars still do not animate, describe what you see (e.g. "bar jumps instantly", "bar does not move at all").
    </manual>
  </verify>
  <done>User types "approved" confirming bars animate smoothly on damage and recharge. Gap-01 closed.</done>
</task>

</tasks>

<verification>
Gap-01 closure checklist:
- [ ] `_shieldRatioCurrent` and `_healthRatioCurrent` removed from HUD.js (grep returns no matches)
- [ ] `_shieldProxy` and `_healthProxy` exist in HUD.js constructor (grep confirms)
- [ ] Tween config uses `ratio` as the property name (no underscore — Phaser will animate it)
- [ ] Fill draw reads `this._shieldProxy.ratio` and `this._healthProxy.ratio`
- [ ] No regression: shieldGlow pulse, low-HP pulse, streak counter, XP bar all still work
- [ ] Human confirms bars visibly animate on damage
</verification>

<success_criteria>
- Shield bar visibly slides to reflect damage within ~150ms — confirmed by human in Task 2
- HP bar visibly slides on HP loss — confirmed by human in Task 2
- `_shieldRatioCurrent` and `_healthRatioCurrent` do not appear anywhere in src/systems/HUD.js
- `_shieldProxy` and `_healthProxy` exist as plain objects in the HUD constructor
- No Phaser console errors during gameplay
</success_criteria>

<output>
After completion, create `.planning/phases/01-hud-orb-clarity/01-03-SUMMARY.md`
</output>
