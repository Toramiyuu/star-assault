---
phase: 02-drop-icons
plan: "02"
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - src/systems/GroundDropManager.js
autonomous: false
requirements:
  - VISC-02

must_haves:
  truths:
    - "All six drop types render as distinct sprite icons — no text label appears on any drop"
    - "Heart is red, Shield is blue, Bomb is black with fuse, Magnet is cyan, Boost is yellow >>, EliteShard is purple gem with sparkles"
    - "Drops bob ~8px vertically with a 1.5s cycle while idle; bob stops when within attract radius"
    - "In the final 3 seconds of lifetime, drops flicker at increasing frequency"
    - "Collecting any drop except Bomb plays a scale-burst to 1.5x + white flash + alpha fade"
    - "Collecting a Magnet drop does NOT crash the game; all XP orbs teleport to player"
    - "No floating text appears on any drop collect (+HP, +SHIELD, MAGNET!, BOOST!, +STREAK all removed)"
  artifacts:
    - path: "src/systems/GroundDropManager.js"
      provides: "Sprite-based drop system with bob, flicker, collect burst, sparkles, MAG crash fix"
      contains: "scene.add.image"
  key_links:
    - from: "src/systems/GroundDropManager.js"
      to: "Phaser Texture Manager (via Plan 02-01)"
      via: "this.scene.add.image(x, y, `drop_${type}`)"
      pattern: "add\\.image.*drop_"
    - from: "_collectDrop (magnet case)"
      to: "scene.xpManager.orbs"
      via: "scene.xpManager.orbs.forEach(orb => { orb.x = px; orb.y = py; })"
      pattern: "xpManager\\.orbs\\.forEach"
    - from: "update() loop"
      to: "drop.sprite"
      via: "drop.sprite.setPosition(drop.x, bobY) / drop.sprite.setAlpha(flicker)"
      pattern: "setPosition|setAlpha"
---

<objective>
Rewrite GroundDropManager to use sprite-based drops from the textures generated in Plan 02-01. Replaces the Graphics+Text label architecture entirely. Implements sinusoidal bob, urgency flicker, collect burst, EliteShard sparkle particles, and fixes the MAG crash bug.

Purpose: Delivers VISC-02 — players can now identify drop type at a glance via icon silhouette, with no text labels. The collect burst provides instant feedback without reading.

Output: Modified GroundDropManager.js with sprite-based drops, full idle + collect animation, MAG crash fixed, floating text on collect removed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-drop-icons/02-CONTEXT.md
@.planning/phases/02-drop-icons/02-RESEARCH.md
@src/systems/GroundDropManager.js
@.planning/phases/02-drop-icons/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace _createDrop / _destroyDrop / update() with sprite-based architecture + MAG crash fix</name>
  <files>src/systems/GroundDropManager.js</files>
  <action>
    This task is a targeted rewrite of the drop object lifecycle. The DROPS config, DROP_TYPES, spawn methods (trySpawnDrop, spawnGuaranteed, spawnBossDrops), and bomb drama (_playBombDrama) are UNCHANGED. Modify only the methods listed below.

    **1. Update constants block** — add bob and flicker constants after existing constants:

    ```js
    const BOB_AMPLITUDE  = 8;
    const BOB_SPEED      = 0.00418; // rad/ms — 1.5s full cycle (2π / 1500)
    const FLICKER_START  = 7000;    // ms — begin urgency flicker at 7s
    ```

    **2. Replace `_createDrop(x, y, type)`** — remove all Graphics, Text, spin tween, and pulse tween. Create a sprite instead:

    ```js
    _createDrop(x, y, type) {
      const cfg = DROPS[type];
      if (!cfg) return;

      const sprite = this.scene.add.image(x, y, `drop_${type}`);
      sprite.setDepth(8);
      sprite.setScale(1.0); // 80px texture renders at 80px; legible at 1080px wide mobile

      const drop = {
        x,
        y,
        baseY: y,
        type,
        color: cfg.color,
        spawnTime: this.scene.time.now,
        bobPhase: this.random() * Math.PI * 2, // random phase so drops don't sync
        sprite,
        collected: false,
        attracting: false,
        sparkleTimer: 0,
      };

      this.drops.push(drop);
    }
    ```

    **3. Replace `_destroyDrop(drop)`** — kills sprite and any lingering tweens:

    ```js
    _destroyDrop(drop) {
      if (drop.sprite) {
        this.scene.tweens.killTweensOf(drop.sprite);
        drop.sprite.destroy();
        drop.sprite = null;
      }
    }
    ```

    **4. Replace `update(time, delta)`** — full rewrite. Keep same outer structure (reverse loop, collected/lifetime checks, collect/attract distance checks) but replace gfx/label position calls with sprite-based bob, flicker, and attract logic.

    Critical branch logic:
    - If `drop.attracting`: set sprite position to `(drop.x, drop.y)` with NO bob applied — prevents jitter.
    - If NOT `drop.attracting`: compute `bobY = drop.baseY + BOB_AMPLITUDE * Math.sin(time * BOB_SPEED + drop.bobPhase)` and call `drop.sprite.setPosition(drop.x, bobY)`.
    - Flicker/alpha: if `age > FLICKER_START && !drop.attracting`, compute urgency flicker; else if `age > LIFETIME - FADE_TIME`, smooth fade; else setAlpha(1).
    - Set `drop.attracting = true` when `dist < ATTRACT_DIST`. When attracting, slide drop position toward player with `drop.x += dx * 0.1; drop.y += dy * 0.1`.
    - For EliteShard drops that are NOT attracting: call `this._updateEliteShardSparkle(drop, delta)`.

    ```js
    update(time, delta) {
      const player = this.scene.player;
      if (!player?.active) return;

      const px = player.x;
      const py = player.y;

      for (let i = this.drops.length - 1; i >= 0; i--) {
        const drop = this.drops[i];
        if (drop.collected) {
          this.drops.splice(i, 1);
          continue;
        }

        if (!drop.sprite) {
          this.drops.splice(i, 1);
          continue;
        }

        const age = time - drop.spawnTime;

        if (age > LIFETIME) {
          this._destroyDrop(drop);
          this.drops.splice(i, 1);
          continue;
        }

        // --- Alpha / flicker ---
        if (drop.attracting) {
          drop.sprite.setAlpha(1);
        } else if (age > FLICKER_START) {
          const urgencyT = (age - FLICKER_START) / (LIFETIME - FLICKER_START);
          const freq = 0.01 + urgencyT * 0.04;
          drop.sprite.setAlpha(0.4 + 0.6 * Math.abs(Math.sin(time * freq)));
        } else if (age > LIFETIME - FADE_TIME) {
          drop.sprite.setAlpha((LIFETIME - age) / FADE_TIME);
        } else {
          drop.sprite.setAlpha(1);
        }

        // --- Distance ---
        const dx = px - drop.x;
        const dy = py - drop.y;
        const dist = Math.sqrt(dx * dx + dy * dy);

        if (dist < COLLECT_DIST) {
          this._collectDrop(drop);
          drop.collected = true;
          this.drops.splice(i, 1);
          continue;
        }

        if (dist < ATTRACT_DIST) {
          drop.attracting = true;
          drop.x += dx * 0.1;
          drop.y += dy * 0.1;
          drop.sprite.setPosition(drop.x, drop.y);
        } else {
          // Sinusoidal bob — stopped when attracting
          const bobY = drop.baseY + BOB_AMPLITUDE * Math.sin(time * BOB_SPEED + drop.bobPhase);
          drop.sprite.setPosition(drop.x, bobY);

          // EliteShard sparkles while idle
          if (drop.type === 'elite_shard') {
            this._updateEliteShardSparkle(drop, delta);
          }
        }
      }
    }
    ```

    **5. Fix MAG crash in `_collectDrop`** — replace the broken `orbGroup.getChildren()` call with direct iteration of `xpManager.orbs` array. Remove ALL `scene.showFloatingText()` calls from every case (CONTEXT.md: icon flash is the feedback — no floating text on any collect):

    ```js
    _collectDrop(drop) {
      const scene = this.scene;

      switch (drop.type) {
        case 'heart': {
          scene.hp = Math.min(scene.hp + 1, scene.playerMaxHP);
          if (scene.hud) scene.hud.update(scene.score, scene.hp);
          break;
        }

        case 'shield': {
          scene.playerShieldCurrent = Math.min(
            scene.playerShieldCurrent + 1,
            scene.playerShield
          );
          if (scene.hud) scene.hud.update(scene.score, scene.hp);
          break;
        }

        case 'bomb': {
          // Bomb drama is the feedback — skip collect burst; destroy sprite immediately
          if (drop.sprite) { drop.sprite.destroy(); drop.sprite = null; }
          this._playBombDrama(drop.x, drop.y);
          return; // early return — sprite already gone, skip _playCollectBurst below
        }

        case 'magnet': {
          // FIX: iterate xpManager.orbs array directly (NOT orbGroup.getChildren — that crashes)
          if (scene.xpManager && scene.xpManager.orbs) {
            const mpx = scene.player.x;
            const mpy = scene.player.y;
            scene.xpManager.orbs.forEach(orb => {
              orb.x = mpx;
              orb.y = mpy;
              orb.vx = 0;
              orb.vy = 0;
            });
          }
          break;
        }

        case 'boost': {
          if (scene.playerStats) {
            scene.playerStats.addPercent('playerFireRate', 0.5);
            scene.time.delayedCall(8000, () => {
              scene.playerStats.removePercent('playerFireRate', 0.5);
            });
          }
          break;
        }

        case 'elite_shard': {
          scene.killStreak = (scene.killStreak || 0) + 1;
          scene.isInvulnerable = true;
          scene.time.delayedCall(500, () => {
            scene.isInvulnerable = false;
            if (scene.player?.active) scene.player.setAlpha(1);
          });
          break;
        }
      }

      // Collect burst for all non-bomb drops
      this._playCollectBurst(drop.sprite);
      drop.sprite = null; // burst tween owns the sprite now
    }
    ```

    Note: The early `return` in the `bomb` case means `_playCollectBurst` is NOT called for bombs — existing bomb drama handles all feedback.
  </action>
  <verify>
    <automated>cd "C:/Users/user/Documents/Development/star-assault" && npm run build 2>&1 | tail -5</automated>
    <manual>Open npm run preview in browser. Start a game. Verify: (1) drops appear as colored icons (not circles/hexagons), (2) bob animation visible, (3) picking up Magnet does not crash, (4) no text floats up from any drop collect.</manual>
    <sampling_rate>Run npm run build immediately after this task</sampling_rate>
  </verify>
  <done>Build passes. GroundDropManager._createDrop creates a sprite from drop_* texture keys. update() drives bob via Math.sin. _collectDrop magnet case iterates scene.xpManager.orbs array. No showFloatingText calls remain in _collectDrop. Bomb case returns early without collect burst.</done>
</task>

<task type="auto">
  <name>Task 2: Add _playCollectBurst() and _updateEliteShardSparkle() helpers</name>
  <files>src/systems/GroundDropManager.js</files>
  <action>
    Add two helper methods to GroundDropManager after `_destroyDrop`. These were referenced in Task 1 but not yet implemented.

    **`_playCollectBurst(sprite)`** — scale burst + white flash + fade:

    ```js
    _playCollectBurst(sprite) {
      if (!sprite) return;
      this.scene.tweens.killTweensOf(sprite);
      this.scene.tweens.add({
        targets: sprite,
        scaleX: 1.5,
        scaleY: 1.5,
        duration: 150,
        ease: 'Back.easeOut',
        onComplete: () => {
          sprite.setTint(0xffffff);
          this.scene.tweens.add({
            targets: sprite,
            alpha: 0,
            duration: 100,
            onComplete: () => sprite.destroy(),
          });
        },
      });
    }
    ```

    Note: `sprite.setTint(0xffffff)` in Phaser 4 multiplies all channels by 1.0 — it effectively clears any existing tint and creates a slight brightening effect. If this isn't visually distinct during testing, the reviewer checkpoint in Task 3 will catch it and we can add a white Graphics overlay flash at the sprite position (same pattern as `_playBombDrama` white flash).

    **`_updateEliteShardSparkle(drop, delta)`** — emits 1 purple/gold sparkle Graphics every 300ms while drop is idle:

    ```js
    _updateEliteShardSparkle(drop, delta) {
      drop.sparkleTimer += delta;
      if (drop.sparkleTimer < 300) return;
      drop.sparkleTimer = 0;

      const p = this.scene.add.graphics().setDepth(9);
      const angle = this.random() * Math.PI * 2;
      const dist  = 20 + this.random() * 20;
      const tx = drop.x + Math.cos(angle) * dist;
      const ty = (drop.sprite ? drop.sprite.y : drop.y) + Math.sin(angle) * dist;
      const color = this.random() > 0.5 ? 0xAA44FF : 0xFFCC00;

      p.fillStyle(color, 0.9);
      p.fillCircle(drop.x, drop.sprite ? drop.sprite.y : drop.y, 3);

      this.scene.tweens.add({
        targets: p,
        x: tx - drop.x,         // relative offset so tween moves the Graphics object
        y: ty - (drop.sprite ? drop.sprite.y : drop.y),
        alpha: 0,
        scaleX: 0.3,
        scaleY: 0.3,
        duration: 500 + this.random() * 300,
        ease: 'Quad.easeOut',
        onComplete: () => p.destroy(),
      });
    }
    ```

    Note on sparkle tween: Graphics objects tween their `x`/`y` world coordinates. Set the Graphics position at the drop center first, then tween toward the computed target offset. Alternatively: draw the dot at (0, 0) relative to the Graphics object's position, then set gfx position to drop center and tween to target position. Use this cleaner form:

    ```js
    _updateEliteShardSparkle(drop, delta) {
      drop.sparkleTimer += delta;
      if (drop.sparkleTimer < 300) return;
      drop.sparkleTimer = 0;

      const originX = drop.x;
      const originY = drop.sprite ? drop.sprite.y : drop.y;
      const angle   = this.random() * Math.PI * 2;
      const radius  = 20 + this.random() * 20;
      const tx      = originX + Math.cos(angle) * radius;
      const ty      = originY + Math.sin(angle) * radius;
      const color   = this.random() > 0.5 ? 0xAA44FF : 0xFFCC00;

      const p = this.scene.add.graphics().setDepth(9);
      p.setPosition(originX, originY);
      p.fillStyle(color, 0.9);
      p.fillCircle(0, 0, 3); // draw at (0,0) relative to Graphics position

      this.scene.tweens.add({
        targets: p,
        x: tx,
        y: ty,
        alpha: 0,
        scaleX: 0.3,
        scaleY: 0.3,
        duration: 500 + this.random() * 300,
        ease: 'Quad.easeOut',
        onComplete: () => p.destroy(),
      });
    }
    ```

    Also update `destroy()` to clean up only sprites (no gfx/label references remain):

    ```js
    destroy() {
      for (const drop of this.drops) {
        this._destroyDrop(drop);
      }
      this.drops.length = 0;
    }
    ```

    (The existing `_destroyDrop` already handles the sprite null-check, so destroy() just calls it.)
  </action>
  <verify>
    <automated>cd "C:/Users/user/Documents/Development/star-assault" && npm run build 2>&1 | tail -5</automated>
    <manual>In browser: spawn an EliteShard drop (use dev key I=god + trigger elite kill or direct spawnGuaranteed). Verify sparkle particles float outward. Collect a Heart/Shield/Boost/EliteShard — verify scale burst + fade animation fires.</manual>
    <sampling_rate>Run npm run build after this task, before the visual checkpoint</sampling_rate>
  </verify>
  <done>Build passes. _playCollectBurst() and _updateEliteShardSparkle() exist as methods. No syntax errors. Collect burst tweens chain: scale→white flash→fade→destroy.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual QA — verify all 6 icon types, animations, collect burst, MAG crash fix</name>
  <what-built>
    Full ground drop icon system:
    - Six distinct 80px sprite icons replace the old circles/hexagons + text labels
    - Sinusoidal bob (8px amplitude, 1.5s cycle) while idle; stops on attract
    - Urgency flicker in final 3 seconds of lifetime
    - Collect burst: scale 1→1.5x + white flash + alpha fade (all drops except Bomb)
    - MAG crash fixed: magnet collect iterates xpManager.orbs array safely
    - EliteShard sparkle particles float outward while bobbing
    - All floating text on collect removed (+HP, +SHIELD, MAGNET!, BOOST!, +STREAK gone)
  </what-built>
  <how-to-verify>
    Run: `npm run dev` in the project directory, open http://localhost:5173 in browser.

    Set browser to iPhone 12 Pro viewport in DevTools (390px width).

    Start a game and press I for god mode.

    Verify each drop type:
    1. Heart drop (red) — appears as red heart silhouette, no text
    2. Shield drop (blue) — appears as blue shield/chevron, no text
    3. Bomb drop (black) — appears as black bomb + fuse + orange tip, no text
    4. Magnet drop (cyan) — appears as cyan U-shape horseshoe, no text
    5. Boost drop (yellow) — appears as yellow double->> chevrons, no text
    6. EliteShard drop (purple) — appears as purple gem + gold inner facet, sparkles visible, no text

    Behavioral checks:
    7. All drops gently bob up/down while on the ground
    8. Bob stops cleanly when drop slides toward player (no jitter/snap at attract boundary)
    9. Let a drop age past 7 seconds — it should flicker/flash with increasing urgency
    10. Collect a Heart/Shield/Boost/EliteShard — icon should burst to ~1.5x size, flash, then fade out (NOT jump-destroy)
    11. Collect a Magnet drop — verify NO console error, XP orbs on screen should teleport to player
    12. Collect a Bomb drop — existing bomb drama fires (BOOM!, flash, ring), no scale burst
    13. Collect any drop — confirm NO floating text appears (+HP, +SHIELD, etc.)

    Check browser console for errors throughout.
  </how-to-verify>
  <resume-signal>Type "approved" if all 13 checks pass. Describe any specific failures (e.g., "item 4: Magnet still crashes" or "item 10: no burst animation visible").</resume-signal>
</task>

</tasks>

<verification>
Overall phase VISC-02 satisfied when:
- `npm run build` exits 0
- Visual QA: all 6 icon types visually distinct at 390px viewport
- No text labels on any drop
- Bob, flicker, collect burst, sparkles all fire correctly
- MAG pickup does not crash
- No floating text on any collect
</verification>

<success_criteria>
- All six drop types display a distinct colored icon (no text label anywhere)
- Picking up Magnet does not throw a TypeError
- Collect burst (scale + flash + fade) fires on Heart, Shield, Boost, EliteShard drops
- Drops bob while idle, stop bobbing when attracted
- Urgency flicker visible in final 3 seconds
- EliteShard emits purple/gold sparkle particles while idle
- npm run build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-drop-icons/02-02-SUMMARY.md`
</output>
