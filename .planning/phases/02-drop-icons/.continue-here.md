---
phase: 02-drop-icons (extended bug-fix session)
task: ongoing
status: in_progress
last_updated: 2026-02-27T04:40:25.435Z
---

<current_state>
Mid-session hotfix work — not a formal GSD phase plan. User reported multiple in-game bugs
after Phase 02 completion and the session addressed them directly in source files.
No new PLAN.md was created; changes were applied directly.
</current_state>

<completed_work>

- Drop icon black-box / white-halo fix:
  - PreloadScene: Load PNGs with `_src` suffix, run `_processDropPNGs()` before `_generateDropTextures()`
  - `_processDropPNGs()` applies existing `_removeWhiteBG()` flood-fill to strip solid backgrounds from AI PNGs
  - `_generateDropTextures()` restored to skip-if-exists (AI PNG takes priority if clean)
  - Backing circle reduced from 60% → 30% opacity with tinted colors per type
  - Bomb body color changed from near-black 0x111111 → visible 0x444444

- Drop spawn position clamping:
  - Added SPAWN_X_MIN/MAX and SPAWN_Y_MIN/MAX constants (80px sides, 200–1700 Y)
  - `_createDrop()` clamps rawX/rawY before creating sprite
  - Drops no longer spawn in unreachable top/bottom strips

- Drop icon scale fix:
  - `sprite.setScale(60 / sprite.width)` — dynamic, works for any texture size
  - AI PNG (~1024px) → scale ~0.059, programmatic 80px fallback → scale 0.75

- Damaged sprite size preservation (WaveManager.js):
  - Save `displayWidth/displayHeight` before `setTexture(_damaged)`
  - Restore with `setDisplaySize(savedW, savedH)` after texture swap
  - Prevents enemy appearing larger when _damaged PNG has different pixel dimensions

- XP threshold: level-based scaling (XPManager.js):
  - Was: wave-bracket flat values (50/90/140/200)
  - Now: `return 50 + this.level * 20`
  - Level 0→1: 50 XP, Level 5→6: 150, Level 10→11: 250, Level 20→21: 450

- Magnet XP orb tween feel (GroundDropManager.js):
  - Duration: 320ms → 700ms
  - Stagger delay: i*18ms → i*35ms
  - Orbs visibly travel to player before XP registers

- Upgrade card rarity coloring (UpgradeCardUI.js):
  - Extracted `_drawCardBg(bg, rarityHex, highlighted)` helper
  - Added rarity tint overlay (12% idle / 18% hover) over dark card body
  - Added top color band (30% idle / 45% hover) — rarity immediately visible
  - Left accent bar widened 6px → 10px
  - Rarity badge fill: 0.25 → 0.85 opacity (was invisible, now clearly colored)
  - All three draw contexts (initial, hover, out) now use the helper

</completed_work>

<remaining_work>

- **Upgrade icon art**: `assets/upgrade-icons/` is empty — all cards show letter fallback circles.
  `scripts/generate-upgrade-icons.js` exists but hasn't been run.
  User asked "where is the AI art" — needs icons generated via the script or manually.

- **Death animation "turns blue"**: User reported enemies turn blue and appear bigger when dying.
  - Size issue FIXED (displaySize preservation above)
  - "Turns blue" root cause still unclear — likely the `_damaged` PNG art itself has blue tones,
    OR the cyan shield-hit tint (0x44ffff) is not clearing before enemy dies in some edge case.
    Needs in-game testing after size fix to confirm if still an issue.

- **Upgrade card icon fallback quality**: Letter circles (P/W/D/U/C/H) are not descriptive.
  Could be improved with type-specific programmatic icons if AI generation is not run.

- **Next formal phase**: Phase 3 (Weapon Visual Feedback) — not started, no PLAN.md yet.
  Plans: 03-01 CombatUtils killEnemy(), 03-02 hit flash + death particles, 03-03 TwinLaser glow.

</remaining_work>

<decisions_made>

- `_processDropPNGs()` uses `_src` suffix keys to avoid polluting final texture namespace before bg removal
- Dynamic scale `60 / sprite.width` chosen over hardcoded to handle any future texture size
- XP threshold formula `50 + level * 20` chosen (linear) — matches Survivor.io ramp feel without
  exponential runaway that would make late levels impossible
- `_drawCardBg` helper extracted to eliminate 3x duplicated bg drawing code in UpgradeCardUI
- Magnet 700ms duration with i*35ms stagger gives clear visual travel without feeling sluggish

</decisions_made>

<blockers>

- Upgrade icon art: needs `node scripts/generate-upgrade-icons.js` run (Gemini API required)
- "Turns blue on death" still needs in-game verification after the displaySize fix

</blockers>

<context>
Session was a hotfix round triggered by user screenshots showing bugs in Phase 02 work.
Not a formal phase — direct edits to src/ files. No PLAN.md or SUMMARY.md was created for this work.
The Phase 02 ROADMAP entry still shows "Not started" for Phase 2 (roadmap wasn't updated to mark it complete).
STATE.md correctly shows Phase 2 as COMPLETE.

Next session should:
1. Verify drop icon bg-removal is working in-browser
2. Run `scripts/generate-upgrade-icons.js` to generate upgrade icon art
3. Confirm death-blue issue resolved or investigate further
4. Then proceed to Phase 3 planning: `/gsd:plan-phase 3`
</context>

<next_action>
Start by running the game and verifying drop icons show clean (no black boxes/white halos).
Then run `node scripts/generate-upgrade-icons.js` to generate upgrade art.
Then `/gsd:resume-work` to check state and plan Phase 3.
</next_action>
