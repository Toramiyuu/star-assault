---
phase: 03-weapon-feedback
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/CombatUtils.js
  - src/scenes/GameSceneCollisions.js
  - src/weapons/TwinLaser.js
  - src/systems/GroundDropManager.js
  - src/weapons/PhotonDevastator.js
autonomous: true
requirements:
  - CMBT-04

must_haves:
  truths:
    - "TwinLaser kills increment kill streak, spawn XP orbs, and trigger ground drop spawns"
    - "Bomb AoE kills increment kill streak, spawn XP orbs, and trigger ground drop spawns"
    - "PhotonDevastator kills route through the same kill path as bullet kills"
    - "Bullet kills continue to work exactly as before (no regression)"
  artifacts:
    - path: "src/utils/CombatUtils.js"
      provides: "Shared killEnemy(scene, enemy) helper consolidating all kill side-effects"
      exports: ["killEnemy"]
    - path: "src/scenes/GameSceneCollisions.js"
      provides: "Bullet kill path imported from CombatUtils"
      contains: "import.*CombatUtils"
    - path: "src/weapons/TwinLaser.js"
      provides: "TwinLaser kill path routed through killEnemy()"
      contains: "killEnemy"
    - path: "src/systems/GroundDropManager.js"
      provides: "Bomb AoE kill path routed through killEnemy()"
      contains: "killEnemy"
    - path: "src/weapons/PhotonDevastator.js"
      provides: "PhotonDevastator kill path routed through killEnemy()"
      contains: "killEnemy"
  key_links:
    - from: "src/weapons/TwinLaser.js"
      to: "src/utils/CombatUtils.js"
      via: "import { killEnemy } at top of file"
      pattern: "killEnemy\\(this\\.scene"
    - from: "src/systems/GroundDropManager.js"
      to: "src/utils/CombatUtils.js"
      via: "import { killEnemy } at top of file"
      pattern: "killEnemy\\(scene"
    - from: "src/scenes/GameSceneCollisions.js"
      to: "src/utils/CombatUtils.js"
      via: "import { killEnemy } at top of file"
      pattern: "killEnemy\\(scene"
---

<objective>
Extract a shared killEnemy() helper into CombatUtils.js that consolidates all kill side-effects (explosion, audio, kill streak, XP orb, ground drop, score, Nebula Rounds, Death Nova, enemy.destroy(), waveManager.onEnemyRemoved()), then route all three broken kill paths (TwinLaser, GroundDropManager bomb AoE, PhotonDevastator) through it.

Purpose: This is the prerequisite for all other Phase 3 visual work. TwinLaser and bomb kills currently bypass kill streak, ground drops, and score — confirmed in RESEARCH.md. Every effect that needs the "kill event" (particles, streak counter, drops) depends on this consolidation happening first.

Output: src/utils/CombatUtils.js with killEnemy() + 4 modified files routing through it
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/03-weapon-feedback/03-CONTEXT.md
@.planning/phases/03-weapon-feedback/03-RESEARCH.md
@src/scenes/GameSceneCollisions.js
@src/weapons/TwinLaser.js
@src/systems/GroundDropManager.js
@src/weapons/PhotonDevastator.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CombatUtils.js with killEnemy() helper</name>
  <files>src/utils/CombatUtils.js</files>
  <action>
Create a new file `src/utils/CombatUtils.js`. This file must be ES module format (no default exports) consistent with project conventions.

Export a single function `killEnemy(scene, enemy)` that consolidates all kill side-effects currently scattered across GameSceneCollisions.js lines 111-155. The function must:

1. Guard against double-calls: at the top, `if (!enemy.active) return;` then immediately `enemy.setActive(false).setVisible(false);` to prevent double-kill from TwinLaser lingering (Pitfall 3 from RESEARCH.md).

2. Capture position before deactivation: `const x = enemy.x; const y = enemy.y;`

3. Read enemy metadata: `const enemyType = enemy.getData('enemyType') || 'grunt'; const isElite = enemy.getData('isElite') || false; const bomberState = enemy.getData('bomberState');`

4. Explosion + audio: `scene.explosions.play(x, y, 'enemy_explosion', 9, 0.12); scene.audio.playEnemyExplosion();`
   - NOTE: explosion prefix stays 'enemy_explosion' for now — Plan 02 will add craftpix explosions and call spawnFragments() from here

5. Camera shake (keep existing): `scene.cameras.main.shake(80, 0.003);`

6. Score: `const killType = isElite ? 'elite' : 'basic'; const pts = scene.scoreManager.addKill(killType) * scene.powerups.getScoreMultiplier(); scene.score = scene.scoreManager.score;`

7. Floating score text (keep existing): `scene.showFloatingText(x, y - 30, '+' + pts, '#ffffff');`

8. Kill streak: `scene.killStreak = (scene.killStreak || 0) + 1;`

9. XP orb: `if (scene.xpManager) { let xp = scene.xpManager.getXPForEnemy(enemyType); if (isElite) xp = Math.round(xp * 2.5); scene.xpManager.spawnOrb(x, y, xp); }`

10. Ground drop: `if (scene.groundDrops) { if (enemyType === 'bomber' && bomberState !== 'detonate') { scene.groundDrops.spawnGuaranteed(x, y, 'bomb'); } else { scene.groundDrops.trySpawnDrop(x, y, isElite); } }`

11. Nebula Rounds: `if (scene.nebulaRoundsActive && scene.weaponManager?.weapons?.get('B07')) { scene.weaponManager.weapons.get('B07').createCloud(x, y); }`

12. Death Nova: `if (scene.upgradeManager) { scene.upgradeManager.checkDeathNova(x, y); }`

13. Cleanup: `enemy.destroy(); scene.waveManager.onEnemyRemoved();`

Also export a helper `flashEnemy(scene, enemy, flashColor, duration)` that will be used by Plan 02's hit flash system. Implement the timer-gate pattern from RESEARCH.md Pattern 1: cancel any existing `_flashTimer` data handle before setting a new one, restore to elite tint (0xffd700), baseTint data, or clearTint() on expiry.

File path: `src/utils/CombatUtils.js` — create the directory `src/utils/` if it doesn't exist.
  </action>
  <verify>
    <automated>node -e "import('./src/utils/CombatUtils.js').then(m => { console.log('exports:', Object.keys(m)); if (!m.killEnemy) throw new Error('killEnemy missing'); if (!m.flashEnemy) throw new Error('flashEnemy missing'); console.log('OK'); })" 2>&1 || node --input-type=module -e "import { killEnemy, flashEnemy } from './src/utils/CombatUtils.js'; console.log('CombatUtils OK');"</automated>
    <manual>Check that src/utils/CombatUtils.js exists and exports killEnemy and flashEnemy</manual>
  </verify>
  <done>CombatUtils.js exists at src/utils/CombatUtils.js, exports killEnemy(scene, enemy) and flashEnemy(scene, enemy, flashColor, duration), and contains all 13 kill side-effect steps including the double-call guard at top</done>
</task>

<task type="auto">
  <name>Task 2: Wire all broken kill paths through killEnemy()</name>
  <files>src/scenes/GameSceneCollisions.js, src/weapons/TwinLaser.js, src/systems/GroundDropManager.js, src/weapons/PhotonDevastator.js</files>
  <action>
Route all four kill paths through the new CombatUtils.killEnemy(). Add `import { killEnemy } from '../utils/CombatUtils.js';` (or `../../utils/CombatUtils.js` from weapons/) at the top of each file. Follow the existing import ordering convention (config first, then systems, then utils).

**GameSceneCollisions.js** (bullet kill path — the reference implementation):
- Add import: `import { killEnemy } from '../utils/CombatUtils.js';`
- In `onBulletHitEnemy()`, replace the entire `if (hp <= 0) { ... enemy.destroy(); scene.waveManager.onEnemyRemoved(); }` block (lines ~111-155) with:
  ```js
  if (hp <= 0) {
    killEnemy(scene, enemy);
  }
  ```
- Keep everything ABOVE the `if (hp <= 0)` block unchanged: pierce logic, life steal, crit text, shield check, hit flash, damage number, knockback. Those are non-kill effects that stay in the collision handler.
- The `else { // White hit flash ... }` block stays — it's the non-lethal hit visual, not part of killEnemy.

**TwinLaser.js** (in `fire()` method, lines ~77-88):
- Add import: `import { killEnemy } from '../utils/CombatUtils.js';`
- Replace the entire `if (hp <= 0) { ... e.destroy(); this.scene.waveManager.onEnemyRemoved(); }` block with:
  ```js
  if (hp <= 0) {
    killEnemy(this.scene, e);
  }
  ```
- Remove the duplicate `scene.cameras.main.shake(60, 0.002)` inside TwinLaser's kill block (the shake is now in killEnemy).

**GroundDropManager.js** (in `_playBombDrama()`, bomb AoE kill, lines ~504-512):
- Add import: `import { killEnemy } from '../utils/CombatUtils.js';` at the top of the file.
- Replace the `if (hp <= 0) { scene.explosions.play(...); scene.xpManager... e.destroy(); scene.waveManager.onEnemyRemoved(); }` block with:
  ```js
  if (hp <= 0) {
    killEnemy(scene, e);
  }
  ```
- Remove the surrounding orange tint flash for killed enemies (only the `e.setTint(0xff8800)` restore needs to stay for non-killed enemies). Keep the orange tint flash for enemies that survive the bomb blast.

**PhotonDevastator.js** (in `fire()` method, lines ~43-51):
- Add import: `import { killEnemy } from '../utils/CombatUtils.js';`
- Replace `if (hp <= 0) { this.scene.explosions.play(...); this.scene.audio.playEnemyExplosion(); ...; e.destroy(); this.scene.waveManager.onEnemyRemoved(); }` with:
  ```js
  if (hp <= 0) {
    killEnemy(this.scene, e);
  }
  ```

**Path note for weapons/**: The import from TwinLaser.js and PhotonDevastator.js uses `'../utils/CombatUtils.js'` since both live at `src/weapons/`.

After all changes, verify the game still starts by running `npm run dev` and checking that no import errors appear in the terminal.
  </action>
  <verify>
    <automated>npm run build 2>&1 | tail -20</automated>
    <manual>npm run dev, open http://localhost:5173?dev=1, press B to spawn boss, shoot with main gun — kills should still show +pts floating text. Then get TwinLaser (P01 upgrade) and kill with laser — kill streak counter should increment. Then trigger bomb drop and use it — kill streak should increment from bomb kills.</manual>
  </verify>
  <done>All four files import killEnemy from CombatUtils.js; npm run build completes without errors; kill streak increments on TwinLaser and bomb kills visible in dev mode (X key shows streak HUD)</done>
</task>

</tasks>

<verification>
After Plan 01 completes, verify in dev mode (http://localhost:5173?dev=1):
1. Shoot enemies with main gun — floating +pts text appears, kill streak increments
2. Get TwinLaser (U key for level up, select P01) — kill with laser — kill streak increments (was broken before)
3. Trigger bomb (collect bomb drop) — AoE kills increment kill streak (was broken before)
4. No console errors on kill events
5. `npm run build` exits 0
</verification>

<success_criteria>
- src/utils/CombatUtils.js exists with killEnemy() and flashEnemy() exports
- All 4 kill paths (GameSceneCollisions, TwinLaser, GroundDropManager bomb AoE, PhotonDevastator) import and call killEnemy()
- Kill streak increments from TwinLaser kills — confirmed visually in dev mode
- Kill streak increments from bomb AoE kills — confirmed visually in dev mode
- Bullet kill path works identically to before (score, XP, drops, streak all fire)
- Build is clean (no Vite errors)
</success_criteria>

<output>
After completion, create `.planning/phases/03-weapon-feedback/03-01-SUMMARY.md` summarizing:
- What CombatUtils.js exports and the exact killEnemy() steps included
- Which files were modified and how the duplicate kill code was removed
- Any deviations from the plan (e.g., if GroundDropManager bomb tint needed special handling)
- The _flashTimer gate pattern in flashEnemy() (used by Plan 02)
</output>
