---
phase: 03-weapon-feedback
plan: 02
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - src/scenes/PreloadScene.js
  - src/systems/Explosions.js
  - src/utils/CombatUtils.js
  - src/scenes/GameSceneCollisions.js
autonomous: true
requirements:
  - CMBT-01
  - CMBT-03

must_haves:
  truths:
    - "A white flash appears on the enemy sprite within 100ms of a bullet landing — visible during normal gameplay"
    - "Elite enemies (golden tint) receive a red flash instead of white on hit"
    - "Shield hits on Formation Leaders and Bombers produce a cyan flash — signals shield absorbed, not HP damage"
    - "Crit hits produce a white flash followed by an orange/gold tint briefly visible after the white resolves"
    - "High fire rate does not cause flickering — flash timer gate prevents stacking"
    - "Every enemy death (from any weapon) plays an 8-frame craftpix explosion animation and scatters 4 fragment sprites outward"
    - "Bomber deaths produce a smaller explosion than regular enemies"
    - "Elite enemy deaths produce a larger explosion than regular enemies"
  artifacts:
    - path: "src/scenes/PreloadScene.js"
      provides: "Craftpix explosion frames and fragment sprites loaded as Phaser textures"
      contains: "craftpix_enemy_expl"
    - path: "src/systems/Explosions.js"
      provides: "Supports craftpix 8-frame explosion sets alongside existing 9-frame custom set"
      contains: "craftpix_enemy_expl"
    - path: "src/utils/CombatUtils.js"
      provides: "killEnemy() calls _getExplosionParams() and spawnFragments() on kill"
      contains: "spawnFragments"
  key_links:
    - from: "src/scenes/GameSceneCollisions.js"
      to: "src/utils/CombatUtils.js"
      via: "flashEnemy() call on non-lethal hit and on shield hit"
      pattern: "flashEnemy\\(scene"
    - from: "src/utils/CombatUtils.js"
      to: "src/scenes/PreloadScene.js"
      via: "texture keys craftpix_enemy_expl_0 through _7 and craftpix_enemy_frag_1 through _4"
      pattern: "craftpix_enemy_expl_|craftpix_enemy_frag_"
---

<objective>
Implement the hit flash system (CMBT-01) and death particle effects (CMBT-03). Hit flash uses the flashEnemy() helper from CombatUtils.js (built in Plan 01). Death effects use the craftpix sprite sets: load 8 explosion frames + 4 fragment sprites in PreloadScene, extend Explosions.js, call the craftpix explosion from killEnemy(), and scatter 4 fragment images via tween on each kill.

Purpose: Players must see a clear visual response to every bullet hit and every kill. Currently enemies absorb hits silently (no timer gate on flash = flickering or missing) and die with a simple explosion replacing the enemy sprite. Craftpix fragments make kills feel impactful.

Output: Craftpix textures loaded, flashEnemy() wired into collision handler, killEnemy() upgraded with craftpix explosion + fragment scatter
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/03-weapon-feedback/03-CONTEXT.md
@.planning/phases/03-weapon-feedback/03-RESEARCH.md
@.planning/phases/03-weapon-feedback/03-01-SUMMARY.md
@src/scenes/PreloadScene.js
@src/systems/Explosions.js
@src/utils/CombatUtils.js
@src/scenes/GameSceneCollisions.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Load craftpix explosion and fragment assets in PreloadScene</name>
  <files>src/scenes/PreloadScene.js</files>
  <action>
In `PreloadScene.preload()`, add the craftpix explosion frames and fragment sprites after the existing enemy explosion loads (after the `for (let i = 0; i <= 8; i++) { this.load.image('enemy_explosion_${i}', ...) }` block).

**Explosion frames (8 frames, 1-indexed filenames, load as 0-indexed keys):**
```js
// Craftpix enemy explosion (8 frames, 1-indexed source files)
for (let i = 0; i < 8; i++) {
  const frameNum = String(i + 1).padStart(3, '0');  // '001' through '008'
  this.load.image(
    `craftpix_enemy_expl_${i}`,
    'assets/craftpix-981156-space-shooter-game-kit/Enemy-spaceship-game-sprites/PNG/Ship_Effects_Sprites/Explosion_' + frameNum + '.png'
  );
}
```

**Fragment sprites (4 sprites, 1-indexed):**
```js
// Craftpix enemy ship fragments (4 sprites)
for (let i = 1; i <= 4; i++) {
  this.load.image(
    `craftpix_enemy_frag_${i}`,
    'assets/craftpix-981156-space-shooter-game-kit/Enemy-spaceship-game-sprites/PNG/Ship_Effects/Ship_Fragment_' + i + '.png'
  );
}
```

**Key naming conventions:**
- Explosion keys: `craftpix_enemy_expl_0` through `craftpix_enemy_expl_7` (0-indexed in keys, 001-008 in filenames)
- Fragment keys: `craftpix_enemy_frag_1` through `craftpix_enemy_frag_4`
- These MUST NOT conflict with existing keys `enemy_explosion_0` through `enemy_explosion_8` (Pitfall 6 from RESEARCH.md)

No changes needed to `create()` — these are regular images, not sprite sheets requiring processing.
  </action>
  <verify>
    <automated>npm run build 2>&1 | tail -10</automated>
    <manual>npm run dev — open browser console, check no 404 errors for craftpix asset paths. Run: `window.__GAME__.scene.getScene('Preload')` is already gone after boot, so instead check: `window.__GAME__.scene.getScene('Game').textures.exists('craftpix_enemy_expl_0')` returns true after game starts.</manual>
  </verify>
  <done>PreloadScene.preload() loads craftpix_enemy_expl_0 through _7 and craftpix_enemy_frag_1 through _4; build succeeds; no 404 errors in browser console</done>
</task>

<task type="auto">
  <name>Task 2: Wire hit flash via flashEnemy() and add craftpix death effects to CombatUtils</name>
  <files>src/utils/CombatUtils.js, src/scenes/GameSceneCollisions.js, src/systems/Explosions.js</files>
  <action>
**Part A — Explosions.js extension:**

Explosions.js currently has a single `play(x, y, prefix, frameCount, scale)` method. It already works for the craftpix frames (0-indexed keys) if called with `prefix='craftpix_enemy_expl'` and `frameCount=8`. No changes needed to the core `play()` method.

**Part B — CombatUtils.js: upgrade killEnemy() with craftpix explosion and fragment scatter:**

In `killEnemy(scene, enemy)`, replace the existing `scene.explosions.play(x, y, 'enemy_explosion', 9, 0.12)` call with:

```js
// Select explosion based on enemy type and elite status
const scale = _getExplosionScale(enemyType, isElite);
scene.explosions.play(x, y, 'craftpix_enemy_expl', 8, scale);

// Fragment scatter: 4 fragments radiate outward, fade + shrink
_spawnFragments(scene, x, y, isElite ? 1.4 : 1.0);
```

Add two private helper functions to CombatUtils.js (not exported, just `function` declarations in the module scope):

```js
function _getExplosionScale(enemyType, isElite) {
  // Bomber has a smaller death since AoE is the real spectacle
  if (enemyType === 'bomber') return isElite ? 0.16 : 0.08;
  // Elites get bigger explosion as a reward signal
  if (isElite) return 0.20;
  // Base scale for all regular enemies
  return 0.14;
}

function _spawnFragments(scene, x, y, scaleMultiplier) {
  const count = 4;
  for (let i = 0; i < count; i++) {
    const fragIndex = (i % 4) + 1;  // 1 through 4
    const angle = (Math.PI * 2 / count) * i + (Math.random() - 0.5) * 0.5;
    const speed = 80 + Math.random() * 60;
    const frag = scene.add.image(x, y, `craftpix_enemy_frag_${fragIndex}`)
      .setScale(scaleMultiplier * (0.3 + Math.random() * 0.2))
      .setDepth(25)
      .setAlpha(1);
    scene.tweens.add({
      targets: frag,
      x: x + Math.cos(angle) * speed,
      y: y + Math.sin(angle) * speed,
      scaleX: 0,
      scaleY: 0,
      alpha: 0,
      duration: 400 + Math.random() * 200,
      ease: 'Quad.easeOut',
      onComplete: () => frag.destroy(),
    });
  }
}
```

Note: `Math.random()` is correct here — fragments are purely cosmetic (per CONVENTIONS.md which explicitly permits Math.random() for purely cosmetic effects).

**Part C — GameSceneCollisions.js: wire flashEnemy() for hit flash and shield flash:**

Add `flashEnemy` to the import from CombatUtils: `import { killEnemy, flashEnemy } from '../utils/CombatUtils.js';`

1. **Shield hit flash** (currently lines ~72-86): Replace the manual `enemy.setTintFill(0x44ffff); scene.time.delayedCall(80, () => { ... })` block with:
   ```js
   flashEnemy(scene, enemy, 0x44ffff, 60);
   ```

2. **Non-lethal hit flash** (currently lines ~157-168 in the else block): Replace the manual `enemy.setTintFill(0xffffff); scene.time.delayedCall(60, () => { ... })` block with:
   ```js
   if (enemy.getData('isElite')) {
     // Elite enemies: red flash (signals tankier enemy)
     flashEnemy(scene, enemy, 0xff2222, 50);
   } else {
     // Normal hit: white flash
     flashEnemy(scene, enemy, 0xffffff, 50);
   }
   // Crit: after flash resolves, briefly show orange/gold rim
   if (isCrit && !enemy.getData('isElite')) {
     scene.time.delayedCall(55, () => {
       if (enemy.active) {
         enemy.setTint(0xff8800);
         scene.time.delayedCall(120, () => {
           if (enemy.active) enemy.clearTint();
         });
       }
     });
   }
   ```

The `flashEnemy()` function from CombatUtils.js (written in Plan 01) handles the timer gate, elite tint restore, and baseTint restore. These manual inline timers in GameSceneCollisions should be fully replaced by the flashEnemy() call.
  </action>
  <verify>
    <automated>npm run build 2>&1 | tail -10</automated>
    <manual>npm run dev, open http://localhost:5173?dev=1, start game. Shoot enemies: 1) White flash on hit (normal enemies). 2) Red flash when shooting elite enemies (golden tint — spawn with 8% chance or use I key for god mode and observe). 3) Cyan flash when hitting shielded enemies (Formation Leaders / Bombers appear wave 3+). 4) Rapid fire should not cause flicker — enemy stays white under sustained fire, not alternating. 5) Kill an enemy — 4 fragments should scatter outward and fade.</manual>
  </verify>
  <done>Hit flash visible on every bullet hit (white/red/cyan by enemy type); flash gate prevents stacking at high fire rate; 4 fragment sprites scatter and fade on every kill; craftpix explosion plays on kill; build is clean</done>
</task>

</tasks>

<verification>
After Plan 02 completes, verify all CMBT-01 and CMBT-03 criteria in dev mode (http://localhost:5173?dev=1):
1. Bullet hit on normal enemy → white flash (~50ms) on sprite — CMBT-01 passed
2. Bullet hit on elite (golden) enemy → red flash — CMBT-01 variant passed
3. Bullet hit on Formation Leader/Bomber shield → cyan flash — CMBT-01 variant passed
4. Rapid fire (fire rate upgrade) → no stacking/flickering, enemy stays white during continuous fire — timer gate working
5. Crit hit → white flash then brief orange/gold tint — CMBT-01 crit variant passed
6. Enemy dies → craftpix explosion animation plays + 4 fragment sprites scatter outward — CMBT-03 passed
7. Bomber death → smaller explosion scale than regular enemies — CMBT-03 variant passed
8. Elite enemy death → larger explosion scale than regular — CMBT-03 variant passed
9. `npm run build` exits 0
</verification>

<success_criteria>
- flashEnemy() gates prevent flash stacking at any fire rate
- White/red/cyan flash variants fire correctly by enemy and hit type
- Crit hits show orange/gold follow-up tint after white flash resolves
- 4 craftpix fragment sprites scatter radially from every kill position
- Craftpix 8-frame explosion plays (not the old 9-frame custom set) for regular kills
- Build is clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-weapon-feedback/03-02-SUMMARY.md` summarizing:
- The flashEnemy() flash color matrix (normal=white, elite=red, shield=cyan, crit=orange follow-up)
- The craftpix texture key convention (craftpix_enemy_expl_0..7, craftpix_enemy_frag_1..4)
- The _spawnFragments() scale values used per enemy type
- Any deviation from plan (e.g., if Explosions.js needed modification)
</output>
