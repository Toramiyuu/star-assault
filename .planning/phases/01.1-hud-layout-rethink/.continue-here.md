---
phase: 01.1-hud-layout-rethink
task: 1
total_tasks: 1
status: in_progress
last_updated: 2026-02-27T17:05:28.981Z
---

<current_state>
MID-IMPLEMENTATION — pip-based HP/Shield display. Context ran out mid-edit.

Commit f6c48dd has the pip CSS in index.html but the HTML markup and HUD.js logic are NOT yet updated. The game currently shows broken/missing bars because the HTML still references `.bar-track`/`.bar-fill` divs but the CSS was replaced with `.pip-row`/`.pip` classes.

MUST complete before anything else.
</current_state>

<completed_work>

## Plan 01.1-01 (DONE — commit 84ce49e + 2750572)
- Extracted 13 layout constants to HUD.js module top
- Resized bars to 560×30px, repositioned to Y=160/200
- Moved XP bar to bottom (Y=1760, 920px wide)
- Added dirty-flag guards to shield/HP fill redraws

## Intermediate fix (DONE — commit 5781aa9)
- User said bars too large, covering gameplay
- Reduced: BAR_W=320, BAR_H=18, SHIELD_Y=80, HEALTH_Y=106
- Slimmed hudBg (Y=0-130) and xpBotGrad (28px height)
- Boss bar to Y=140

## FINAL approach — HTML letterbox HUD (DONE — commit 81f2ab0)
User's key insight: the Phaser.Scale.FIT creates ~68px letterbox bars above/below the canvas at 375×802px viewport. Put the entire HUD in those black bars instead of overlaying the canvas.

**3 files changed:**
- `index.html`: Full rewrite — flexbox layout: #hud-top (56px) + #game-container (flex:1) + #hud-bottom (44px). All HUD is HTML/CSS (SH bar, HP bar, WAVE label, score, streak, XP bar + level). CSS transitions replace Phaser tween proxies. CSS animations for shield recharge pulse and low-HP pulse.
- `src/main.js`: Added `parent: 'game-container'` to scale config so canvas renders inside the flex area.
- `src/systems/HUD.js`: Complete rewrite — DOM-based updates via getElementById. Boss bar stays in-canvas (dynamic, complex). No more Phaser Graphics for HUD. No more per-frame clear()+redraw. Dirty-flag cache (_lastScore, _lastShieldRatio, _lastHealthRatio) to avoid unnecessary DOM writes.

Duplicate wave text also fixed: old HUD had waveText on canvas + WaveManager had its own canvas popup. Now: HTML #wave-text (small persistent label) + WaveManager canvas pop-in (big animated). Two different things, no more visual duplicate.
</completed_work>

<remaining_work>

## Immediate — Visual re-test required
Open http://localhost:5173 at 375px DevTools width and confirm:
1. Top black bar shows SH/HP bars + WAVE N + score/streak
2. Bottom black bar shows LV N + XP bar
3. Game canvas is 100% clean — no HUD overlay at all
4. Shield bar animates (CSS transition) when taking damage
5. Boss fight: boss bar appears in canvas near top (Y=60) without conflict

## Then — Close Phase 01.1 formally
After visual confirm: update STATE.md, run `node ./.claude/get-shit-done/bin/gsd-tools.cjs phase complete "01.1"`, commit.

## Then — Phase 2: Ground Drop Icon System
See ROADMAP.md Phase 2. Next command: `/gsd:plan-phase 2`

## Pending Todo
- Fix crash when picking up MAG drop (GroundDropManager) — see .planning/todos/pending/2026-02-26-crash-when-picking-up-mag-drop.md
</remaining_work>

<decisions_made>

- HUD moved to HTML letterbox bars entirely — canvas is now pure game content, zero overlay
- CSS transitions replace Phaser tween proxy pattern (simpler, no Phaser tween lifecycle)
- CSS @keyframes replace per-frame Math.sin glow pulses (shield recharge pulse, low-HP pulse)
- Boss bar kept in-canvas — it's dynamic (appears/disappears, changes color), easier in Phaser
- Wave: small persistent HTML label + big WaveManager canvas pop-in animation (both kept)
- Duplicate wave text was: two canvas texts (HUD waveText + WaveManager popup). Fixed by moving HUD waveText to HTML.
</decisions_made>

<blockers>
- None technical. Game needs visual re-test to confirm HTML HUD renders correctly.
</blockers>

<context>
The core insight driving this session: Phaser.Scale.FIT at 375×802 viewport creates letterbox black bars (~68px top/bottom) because the 1080×1920 canvas only renders to 375×667px. The user spotted this and correctly identified that ALL HUD elements should live in those black bars, keeping the entire canvas for gameplay.

The approach is cleaner than canvas HUD:
- No per-frame Graphics.clear() in hot path
- CSS transitions handle bar animations natively
- No Phaser tween lifecycle management
- HUD is always readable regardless of game background color
- Scales correctly on any viewport height (CSS flexbox handles it)

Key files:
- index.html — the entire HUD layout
- src/systems/HUD.js — DOM update methods (setWave, updateXPBar, updateStreak, update, showBossHP)
- src/main.js — parent: 'game-container' routes canvas into the flex container
</context>

<next_action>
RESUME MID-IMPLEMENTATION — pip HP/Shield display:

1. `/clear` first
2. Read index.html and src/systems/HUD.js in full
3. The pip CSS is already in index.html (commit f6c48dd). Need to:
   a. Replace the `.bar-row` HTML markup in #hud-top with `.pip-row` + `#shield-pips`/`#hp-pips` div containers (remove .bar-track/.bar-fill divs)
   b. Rewrite HUD.js update() to render pips instead of smooth bar:
      - `_renderPips(container, cur, max, filledClass, isRecharging, isLowHp)`
      - Builds N pip divs (N = max), fills first `cur` with filled class
      - Only rebuilds DOM when max changes; only updates classes when cur changes
      - Shield pips: class `filled-shield` + toggle `recharging` on each filled pip
      - HP pips: class `filled-hp` + inline background color (gradient green→red) + toggle `low-hp` on filled pips when hp <= 1
      - Remove elShieldFill/elHpFill refs (no longer exist)
      - Add elShieldPips = getElementById('shield-pips'), elHpPips = getElementById('hp-pips')
4. Test at 375px: pips should show N squares, filled pips for current value, new pip appears on max upgrade
5. Then close Phase 01.1 formally and move to Phase 2
</next_action>
